## Sensitivity Analyses
### Linear uncorrelated model (Little 2001)

Relevant for studies with only category-specific RRs

```{r}
meta_type <- "sens_uncorr"
d_ERR_wide_ma <- d_ERR_uniqueL[[cancer_site]]$d_ERR_wide %>%
    mutate(## take original ERR+CI if available, else use estimated ERR+CI from lm
           used       =get_used(ERR_org, val_gls=rep(NA_real_, n()), val_lm=ERR_lm,  val_ext=ERR_ext),
           ERR        =coalesce(ERR_org,                             ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,                        ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,                        ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org,                     ERR_SE_meta_lm, ERR_SE_meta_ext))
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Pooled ERR on original scale (gls)

```{r}
meta_type <- "sens_org_scale"
d_ERR_wide_ma <- d_ERR_uniqueL[[cancer_site]]$d_ERR_wide %>%
    mutate(## take original ERR+CI if available, else use estimated ERR+CI
           used    =get_used(ERR_org,       ERR_gls,       ERR_lm,      ERR_ext),
           ERR     =coalesce(ERR_org,       ERR_gls,       ERR_lm,      ERR_ext),
           ERR_CIlo=coalesce(ERR_CIlo_org,  ERR_CIlo_gls,  ERR_CIlo_lm, ERR_CIlo_ext),
           ERR_CIup=coalesce(ERR_CIup_org,  ERR_CIup_gls,  ERR_CIup_lm, ERR_CIup_ext),
           ERR_SE  =coalesce(ERR_SE_org,    ERR_SE_gls,    ERR_SE_lm,   ERR_SE_ext))
```

```{r}
pooled_ERR   <- get_ERR_pooled(d_ERR_wide_ma)
ma_weights   <- weights(pooled_ERR)
d_ma_weights <- data.frame(auth_year=names(ma_weights),
                           weight=unname(ma_weights))
    
d_ERR_out <- d_ERR_wide_ma %>%
    mutate(site=cancer_site) %>%
    left_join(d_ma_weights, by="auth_year") %>%
    select(site, auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE, weight, used)

d_ERR_out %>% select(-Study)
```

Metaanalysis: pooled ERR

```{r}
pooled_ERR
```

Prediction interval

```{r}
ci_pred <- predict(pooled_ERR, pi.type="riley")
ci_pred
```

```{r}
assign(paste0("d_ERR_", cancer_site), d_ERR_out %>% mutate(site=cancer_site))
assign(paste0("d_meta_", cancer_site, "_", meta_type),
       data.frame(site=cancer_site,
                  type=meta_type,
                  tau2=pooled_logRR$tau2,
                  # tau2_se=pooled_logRR$se.tau2,
                  I2=pooled_logRR$I2,
                  H2=pooled_logRR$H2,
                  Q=pooled_logRR$QE,
                  Q_pval=pooled_logRR$QEp,
                  ERR=ci_pred$pred,
                  ERR_CIlo=ci_pred$ci.lb,
                  ERR_CIup=ci_pred$ci.ub,
                  ERR_PIlo=ci_pred$pi.lb,
                  ERR_PIup=ci_pred$pi.ub))
```

## Subgroup analyses
### Use all studies, including overlapping data

Also including studies

```{r}
meta_type <- "sens_all"
setdiff(d_RR_allL[[cancer_site]]$auth_year,
        d_RR_uniqueL[[cancer_site]]$auth_year)
```

```{r}
d_ERR_wide_ma <- d_ERR_allL[[cancer_site]]$d_ERR_wide %>%
    mutate(## take original ERR+CI if available, else use estimated ERR+CI
           used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with original ERR/Gy

```{r}
meta_type <- "sens_only_org"
d_ERR_wide_ma <- d_ERR_uniqueL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org, val_gls=NA_real_, val_lm=NA_real_, val_ext=NA_real_),
           ERR        =ERR_org,
           ERR_CIlo   =ERR_CIlo_org,
           ERR_CIup   =ERR_CIup_org,
           ERR_SE_meta=ERR_SE_meta_org) %>%
    filter(used == "org") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies without external comparison

```{r}
meta_type <- "sens_ext_no"
d_ERR_wide_ma <- d_ERR_uniqueL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(!(used %in% c("ext", "none"))) %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with data from children

```{r}
meta_type <- "sens_children"
d_ERR_wide_ma <- d_ERR_childrenL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with data from adults

```{r}
meta_type <- "sens_adults"
d_ERR_wide_ma <- d_ERR_adultsL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with data from patients without chemotherapy

```{r}
meta_type <- "sens_chemo_no"
d_ERR_wide_ma <- d_ERR_chemo_noL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with data from patients with chemotherapy and adjustment

```{r}
meta_type <- "sens_chemo_yes_adj"
d_ERR_wide_ma <- d_ERR_chemo_yes_adjL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

### Use only studies with data from patients without internal exposure (brachytherapy)

```{r}
meta_type <- "sens_brachy_no"
d_ERR_wide_ma <- d_ERR_brachy_noL[[cancer_site]]$d_ERR_wide %>%
    mutate(used       =get_used(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm,         ERR_ext),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm,    ERR_CIlo_ext),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm,    ERR_CIup_ext),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm, ERR_SE_meta_ext)) %>%
    filter(used != "none") %>%
    select(auth_year, Study, ERR, ERR_CIlo, ERR_CIup, ERR_SE_meta, used)
```

```{r, child='metaanalysis_child_meta.Rmd'}
```
