---
title: 'UNSCEAR SPCaRT - Metaanalysis - Linda Walsh'
subtitle: 'All Sites'
author: 'Daniel Wollschl√§ger'
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document: 
    number_sections: yes
    keep_tex: no
    fig_crop: no

header-includes:
    \usepackage{pdflscape}
    \newcommand{\blandscape}{\begin{landscape}}
    \newcommand{\elandscape}{\end{landscape}}
---
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      tidy=FALSE,
                      message=FALSE,
                      warning=FALSE,
                      comment=NA,
                      crop=FALSE,
                      fig_crop=FALSE)

options(replace.assign=TRUE,
        width=75,
        digits=4,
        useFancyQuotes=FALSE,
        show.signif.stars=FALSE,
        scipen=999)

output <- knitr::opts_knit$get("rmarkdown.pandoc.to")
```

```{r echo=FALSE}
#####---------------------------------------------------------------------------
#####---------------------------------------------------------------------------
## load packages
## read data
#####---------------------------------------------------------------------------
#####---------------------------------------------------------------------------

library(dplyr)

source("metaanalysis_global.R")
source("plot_global.R")

## considered cancer sites - will be used in lists to
## identify sub-analyses
cancer_sites <- c("HaemLym",
                  "Sarcoma",
                  "Breast",
                  "Lung",
                  "Gastro",
                  "Thyroid",
                  "Brain")

## used for analysis of all solid cancer
cancer_sites_solid <- c("Sarcoma",
                        "Breast",
                        "Lung",
                        "Gastro",
                        "Thyroid",
                        "Brain")

## names of sensitivity analyses
sens_types <- c("primary",
                "sens_uncorr",
                "sens_synth1",
                "sens_all",
                "sens_only_org",
                "sens_children",
                "sens_adults",
                "sens_chemo_no",
                "sens_chemo_yes_adj",
                "sens_brachy_no",
                "sens_org_scale")

#####---------------------------------------------------------------------------
## load previously generated data and estimates
#####---------------------------------------------------------------------------

d_RR_allL            <- readRDS("d_RR_allL.rda")
d_RR_uniqueL         <- readRDS("d_RR_uniqueL.rda")

d_ERR_allL           <- readRDS("d_ERR_allL.rda")
d_ERR_uniqueL        <- readRDS("d_ERR_uniqueL.rda")
d_ERR_childrenL      <- readRDS("d_ERR_childrenL.rda")
d_ERR_adultsL        <- readRDS("d_ERR_adultsL.rda")
d_ERR_chemo_noL      <- readRDS("d_ERR_chemo_noL.rda")
d_ERR_chemo_yes_adjL <- readRDS("d_ERR_chemo_yes_adjL.rda")
d_ERR_brachy_noL     <- readRDS("d_ERR_brachy_noL.rda")
```

**CAVE** "RR" here may refer to RR, OR, HR

# Methods

  * Primary analysis only uses data from studies with non-overlapping participants

## ERR/Gy from category-specific RRs + CIs

  * Approach as in: Doi et al. 2014: https://doi.org/10.1093/jrr/rru045
  * However, modified step of estimating ERR/Gy based on category-specific RRs.
      * Instead of weighted linear regression with least squares following Little 2001: (https://doi.org/10.1080/09553000010022634) use weighted generalized least squares regression to take into account correlated category RRs, assuming homogeneous correlation matrix with off-diagonal 0.5 per study (based on quick simulation study) following Berrington and Cox. 2003. https://doi.org/10.1093/biostatistics/4.3.423

## Metaanalysis

  * ERRs as given in the publication (if available) or as estimated from category RRs (preferred: gls approach, uncorrelated approach if gls does not converge)
  * SE of log(ERR) derived from CI width assuming log-normality
  * Metaanalysis uses log(ERR+1) as input together with SE on log scale for weighting
  * Metaanalysis results are back-transformed using exp(logRR) - 1

```{r eval=FALSE}
## Sensitivity: Synthetic single ERR estimate from all studies with category RRs

#   * Use all per-study category RRs in a single generalized least squares regression model
#   * Within-study RRs: assume homogeneous correlation matrix with off-diagonal 0.5
#   * Assume no correlation between study RRs
#   * Random effects metaanalysis using synthetic single estimate from category-RR-only studies and studies with ERR/Gy
```

# Haematopoetic / Lymph

```{r}
cancer_site <- "HaemLym"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]], ylim=c(0, 30))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 30), lpos="bottom")
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-0.5, 13),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```


```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

# Sarcoma

```{r}
cancer_site <- "Sarcoma"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]],
                 ylim=c(0, 80))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 80),
                     lpos=c(0.85, 0.12))
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-1.2, 23),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

# Breast

```{r}
cancer_site <- "Breast"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]],
                 ylim=c(0, 10))
```

### Estimated per-study ERR + CIs with category RR + CIs

Note: For Veiga 2019, ERR derived from OR/10 Gy is plotted.

```{r fig.height=8}
d_ERR_Veiga <- d_RR_uniqueL[[cancer_site]] %>%
    filter(auth_year == "Veiga_2019") %>%
    mutate(ERR     =RR-1,
           ERR_CIlo=RR_CIlo-1,
           ERR_CIup=RR_CIup-1,
           from="org") %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    slice(1)

d_ERR_sub <- d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    filter(!((auth_year == "Veiga_2019") & (from == "org")))

d_ERR_plot <- bind_rows(d_ERR_sub, d_ERR_Veiga)

d_ribbon <- data.frame(d_kPrime=seq(from=min(d_RR_uniqueL[[cancer_site]]$d_kPrime, na.rm=TRUE),
                                    to  =max(d_RR_uniqueL[[cancer_site]]$d_kPrime, na.rm=TRUE),
                                    length.out=2))

d_ERR_ribbon <- d_ERR_plot %>%
    full_join(d_ribbon, by=character()) %>%
    mutate(ERR_CI_Ylo=1 + d_kPrime*ERR_CIlo,
           ERR_CI_Yup=1 + d_kPrime*ERR_CIup)

ggplot(d_RR_uniqueL[[cancer_site]]) +
    geom_point(aes(x=d_kPrime, y=RR_cat)) +
    geom_linerange(aes(x=d_kPrime, y=RR_cat,
                       ymin=RR_cat_CIlo, ymax=RR_cat_CIup)) +
    geom_ribbon(data=d_ERR_ribbon,
                aes(x=d_kPrime, ymin=ERR_CI_Ylo, ymax=ERR_CI_Yup,
                    color=from, fill=from), alpha=0.3, linetype=0) +
    geom_abline(data=bind_rows(d_ERR_sub, d_ERR_Veiga),
                aes(intercept=1, slope=ERR, color=from)) +
    coord_cartesian(ylim=c(0, 15)) +
    facet_wrap(~ auth_year) +
    xlab("Dose [Gy]") +
    ylab("RR") +
    ggpt +
    theme(legend.position=c(0.85, 0.12))
```

Only Svahn-Tapper 2006 (off the charts)

```{r}
d_ERR_ribbon_ST2006 <- d_ERR_ribbon %>%
    filter(auth_year == "Svhn-Tp_2006")

d_ERR_long_ST2006 <- d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    filter(auth_year == "Svhn-Tp_2006")

d_RR_ST2006 <- d_RR_uniqueL[[cancer_site]] %>%
    filter(auth_year == "Svhn-Tp_2006")

ggplot(d_RR_ST2006) +
    geom_point(aes(x=d_kPrime, y=RR_cat)) +
    geom_linerange(aes(x=d_kPrime, y=RR_cat,
                       ymin=RR_cat_CIlo, ymax=RR_cat_CIup)) +
    geom_ribbon(data=d_ERR_ribbon_ST2006,
                aes(x=d_kPrime, ymin=ERR_CI_Ylo, ymax=ERR_CI_Yup,
                    color=from, fill=from), alpha=0.3, linetype=0) +
    geom_abline(data=d_ERR_long_ST2006,
                aes(intercept=1, slope=ERR, color=from)) +
    geom_abline(data=d_RR_ST2006,
                aes(intercept=0, slope=RR)) +
    coord_cartesian(ylim=c(0, 100)) +
    xlab("Dose [Gy]") +
    ylab("RR") +
    facet_grid(~ auth_year) +
    ggpt +
    theme(legend.position="bottom")
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-1, 4.5),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

# Lung

```{r}
cancer_site <- "Lung"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]],
                 ylim=c(0, 20))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long, 
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 15),
                     lpos="bottom")
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-0.2, 2.5),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

# Gastro

```{r}
cancer_site <- "Gastro"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]],
                 ylim=c(0, 10))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 15),
                     lpos="bottom")
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-0.2, 2.5),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

# Thyroid

```{r}
cancer_site <- "Thyroid"
```

## Primary analysis - dose threshold 10 Gy
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]], ylim=c(0, 10))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 15),
                     lpos=c(0.85, 0.12))
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-1.2, 20),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

## Dose threshold 5 Gy

```{r}
dose_thresh <- 5
d_ERR_wide <- readRDS(paste0("d_ERR_thyroid_thresh",
                             sprintf("%.2d", dose_thresh), "_sel_wide.rda"))

d_ERR_wide_ma <- d_ERR_wide %>%
    mutate(## take original ERR+CI if available, else use estimated ERR+CI
           used       =get_used(ERR_org,         ERR_gls,         ERR_lm),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm))
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

## Dose threshold 20 Gy

```{r}
dose_thresh <- 20
d_ERR_wide <- readRDS(paste0("d_ERR_thyroid_thresh",
                             sprintf("%.2d", dose_thresh), "_sel_wide.rda"))

d_ERR_wide_ma <- d_ERR_wide %>%
    mutate(## take original ERR+CI if available, else use estimated ERR+CI
           used       =get_used(ERR_org,         ERR_gls,         ERR_lm),
           ERR        =coalesce(ERR_org,         ERR_gls,         ERR_lm),
           ERR_CIlo   =coalesce(ERR_CIlo_org,    ERR_CIlo_gls,    ERR_CIlo_lm),
           ERR_CIup   =coalesce(ERR_CIup_org,    ERR_CIup_gls,    ERR_CIup_lm),
           ERR_SE_meta=coalesce(ERR_SE_meta_org, ERR_SE_meta_gls, ERR_SE_meta_lm))
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

# Brain

```{r}
cancer_site <- "Brain"
```

## Primary analysis
### Category RR + CIs

```{r fig.height=6}
plot_categ_rr_ci(d_RR_uniqueL[[cancer_site]],
                 ylim=c(0, 60))
```

### Estimated per-study ERR + CIs with category RR + CIs

```{r fig.height=8}
plot_err_categ_rr_ci(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                     d_RR_uniqueL[[cancer_site]],
                     ylim=c(0, 60),
                     lpos=c(0.85, 0.12))
```

### Estimated ERR + CIs with original ERR + CIs

```{r results="asis"}
d_ERR_uniqueL[[cancer_site]]$d_ERR_long %>%
    select(auth_year, from, ERR, ERR_CIlo, ERR_CIup) %>%
    knitr::kable(booktabs=TRUE)
```

```{r fig.height=6}
plot_err_org_new(d_ERR_uniqueL[[cancer_site]]$d_ERR_long,
                 ylim=c(-0.1, 15),
                 lpos=c(0.9, 0.2))
```

### Metaanalysis

```{r, child='metaanalysis_child_primary_meta.Rmd'}
```

```{r, child='metaanalysis_child_sensitivity.Rmd'}
```

\blandscape

# All solid cancer
## Primary analysis
### Metaanalysis

```{r}
tables_err_solid <- paste0("d_ERR_site_", cancer_sites_solid)

d_ERR_wide_ma <- do.call("bind_rows", lapply(tables_err_solid, try_get)) %>%
    filter(used != "none") %>%
    select(-weight) %>%
    rename(ERR_SE_meta=ERR_SE)

cancer_site <- "all_solid"
meta_type   <- "special"
```

```{r, child='metaanalysis_child_meta.Rmd'}
```

# Combined results
## ERRs used as input for metaanalysis

```{r}
tables_err_site <- paste0("d_ERR_site_", cancer_sites)

tables_err_all <- do.call("bind_rows", lapply(tables_err_site, try_get)) %>%
    filter(used != "none") %>%
    select(site, auth_year, everything())

writexl::write_xlsx(tables_err_all, "table_err_all.xlsx")

tables_err_all %>%
    knitr::kable()
```

## Metaanalysis results (primary)

```{r}
d_tables_meta_site <- expand.grid(cs=cancer_sites, st=sens_types)
tables_meta_site   <- paste0("d_meta_",
                             d_tables_meta_site$cs, "_",
                             d_tables_meta_site$st)

tables_meta_all <- do.call("bind_rows", lapply(tables_meta_site, try_get)) %>%
    mutate(site=factor(site, levels=cancer_sites),
           type=factor(type, levels=rev(sens_types))) %>%
    select(site, everything())

tables_meta_all %>%
    filter(type == "primary") %>%
    select(-type) %>%
    knitr::kable()
```

\elandscape

## Metaanalysis results (primary and sensitivity)

Sarcoma, thyroid and brain

```{r fig.height=8}
sites_large_err <- c("Sarcoma", "Thyroid", "Brain")
d_plot          <- tables_meta_all %>% filter(site %in% sites_large_err)
plot_meta_results(tables_meta_all)
```

\newpage

Without sarcoma, thyroid and brain due to different magnitude

```{r fig.height=5}
d_plot <- tables_meta_all %>% filter(!(site %in% sites_large_err))
plot_meta_results(d_plot)
```
